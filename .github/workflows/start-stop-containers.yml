name: start-stop-containers

on:
  push:
  workflow_dispatch:

jobs:
  list-services:
    timeout-minutes: 1
    runs-on: ubuntu-latest
    outputs:
      service-list.json: ${{ steps.get-service-list. }}
    steps:
      - id: get-service-list
        # https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#setting-an-output-parameter
        run: |
          echo '::set-output name=service-list.json::"[\"provisioning\"]"'

  start-stop-services:
    needs:
      - list-services
    timeout-minutes: 10
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          include: ${{ fromJson(needs.list-services.outputs.service-list.json) }}
    steps:
      - uses: actions/checkout@v3
      - name: Export UIDs as environment variables
        run: |
          echo "DOCKER_GID=$(getent group docker | cut -d : -f 3)" >> .env
          echo "GID=$(id -g)" >> .env
          echo "UID=$(id -u)" >> .env
      - name: Build containers
        timeout-minutes: 4
        run: |
          docker compose build
      - name: Start services
        timeout-minutes: 4
        run: |
          docker compose up --detach
          sleep 10
      - name: Stop services
        timeout-minutes: 1
        run: |
          docker compose down --remove-orphans --volumes
